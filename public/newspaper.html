<!DOCTYPE html>
<html lang="jp">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <!-- <meta name="viewport" content="width=1500px, initial-scale=0.25, user-scalable=yes"> -->
        <title>Document</title>
        <link rel="stylesheet" href="newspaper.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Outfit:wght@100..900&display=swap"
            rel="stylesheet"
        >
    </head>
    <body>
        <a href="/" class="back-to-list">一覧ページへ戻る</a>
        <div class="newspaper">
            <div class="parent">
                <div class="title-container">
                    <div class="newspaper-name-area newspaper-title">ちょべりぐ新聞</div>
                    <div class="date-area date"></div>
                </div>
                <div class="article-container-1">
                    <div class="article-1-content article-body clickable-article"></div>
                    <div class="article-1-title headline"></div>
                </div>
                <div class="article-container-2">
                    <div class="article-2-content article-body clickable-article"></div>
                    <div class="article-2-title headline"></div>
                </div>
                <div class="article-container-3">
                    <div class="article-3-content article-body clickable-article"></div>
                    <div class="article-3-title headline"></div>
                </div>
                <div class="article-container-4">
                    <div class="article-4-content article-body clickable-article"></div>
                    <div class="article-4-title headline"></div>
                </div>
                <div class="article-container-5">
                    <div class="article-5-content article-body clickable-article"></div>
                    <div class="article-5-title headline"></div>
                </div>
            </div>

            <!-- モーダル -->
            <div id="articleModal" class="modal">
                <div class="modal-area">
                    <span class="close">&times;</span>
                    <h2 id="modalTitle"></h2>
                    <div id="modalContent"></div>
                </div>
            </div>
        </div>
        <a href="/" class="back-to-list">一覧ページへ戻る</a>
    </body>

    <script>
        const queryString = window.location.search;
        const params = new URLSearchParams(queryString);
        const newspaperId = params.get("newspaper-id");

        const testDate = "2025年8月25日（月）";
        let testContents = [];

        document.addEventListener("DOMContentLoaded", async () => {
            const modal = document.getElementById("articleModal");
            const modalTitle = document.getElementById("modalTitle");
            const modalContent = document.getElementById("modalContent");
            const closeBtn = document.getElementsByClassName("close")[0];
            const clickableArticles = document.getElementsByClassName(
                "clickable-article",
            );
            const date = document.getElementsByClassName("date")[0];
            const articleBodyList = document.getElementsByClassName(
                "article-body",
            );
            const articleHeadlineList = document.getElementsByClassName(
                "headline",
            );

            // --- 新聞の内容をHTMLに描画する関数 ---
            const renderContents = (responseToJson) => {
                const contentsList = responseToJson.map((contents) => ({
                    title: contents.title,
                    summary: contents.summary ?? "null",
                }));
                // 配列の内容を順に表示
                if (contentsList) {
                    testContents = contentsList;
                }

                for (let i = 0; i < articleBodyList.length; i++) {
                    articleBodyList[i].textContent = "";

                    const lines = testContents[i].summary.split("\n").filter((line) =>
                        line.trim() !== ""
                    );

                    lines.forEach((line) => {
                        const p = document.createElement("p");
                        p.textContent = line.trim();
                        articleBodyList[i].appendChild(p);
                    });
                }

                for (let i = 0; i < articleHeadlineList.length; i++) {
                    articleHeadlineList[i].textContent = testContents[i].title;
                }

                // 記事クリック時の処理
                for (let i = 0; i < clickableArticles.length; i++) {
                    clickableArticles[i].addEventListener("click", function () {
                        const title = testContents[i].title;
                        const content = testContents[i].summary.split("\n").filter((
                            line,
                        ) => line.trim() !== "");

                        modalTitle.textContent = title;
                        modalContent.textContent = content;
                        modal.style.display = "block";
                        document.body.style.overflow = "hidden";
                    });
                }
            };

            try {
                const endpoint = `/get-summary` +
                    `?newspaper-id=${newspaperId}`;
                const response = await fetch(endpoint);
                const responseToJson = await response.json();
                console.log(responseToJson);
                renderContents(responseToJson);
            } catch (e) {
                console.log("error: ", e);
            }

            date.textContent = testDate;
            // 閉じるボタンクリック時の処理
            closeBtn.addEventListener("click", function () {
                modal.style.display = "none";
                document.body.style.overflow = "auto"; // スクロール有効化
            });

            // モーダル外をクリック時の処理
            window.addEventListener("click", function (event) {
                if (event.target === modal) {
                    modal.style.display = "none";
                    document.body.style.overflow = "auto"; // スクロール有効化
                }
            });

            // ESCキーでモーダルを閉じる
            document.addEventListener("keydown", function (event) {
                if (event.key === "Escape" && modal.style.display === "block") {
                    modal.style.display = "none";
                    document.body.style.overflow = "auto"; // スクロール有効化
                }
            });
        });
    </script>
</html>
