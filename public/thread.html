<!DOCTYPE html>
<html lang="ja">
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="style-thread.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link
            href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Outfit:wght@100..900&display=swap"
            rel="stylesheet"
        >
        <title>掲示板</title>
        <style>
            body {
                font-family: sans-serif;
                padding: 20px;
            }
            .post {
                border: 1px solid #ccc;
                padding: 10px;
                margin-bottom: 10px;
                border-radius: 5px;
            }
            .post .user {
                font-weight: bold;
            }
            .post .date {
                font-size: 0.9em;
                color: #666;
            }
            /* 入力フォームをページ下に配置 */
            .form-container {
                margin-top: 30px;
                padding: 15px;
                border-top: 2px solid #ccc;
            }
            .form-container input, .form-container textarea {
                width: 100%;
                padding: 8px;
                margin-bottom: 10px;
                box-sizing: border-box;
            }
            .form-container button {
                padding: 8px 16px;
                cursor: pointer;
            }
        </style>
    </head>
    <body>
        <a href="/">掲示板一覧へ戻る</a>
        <h1 id="title"></h1>
        <!-- 投稿を表示するエリア -->
        <div id="posts"></div>

        <!-- 入力フォーム -->
        <div class="form-container">
            <h2>新しい投稿</h2>
            <!-- 名前入力欄 -->
            <input type="text" id="userName" value="名無し" placeholder="名前を入力">
            <!-- 投稿内容入力欄 -->
            <textarea id="postContent" rows="4" placeholder="投稿内容を入力"></textarea>
            <!-- 送信ボタン -->
            <button id="submitBtn">送信</button>
        </div>

        <script>
            const queryString = window.location.search;
            const params = new URLSearchParams(queryString);
            const title = params.get("title");

            const titleElement = document.getElementById("title");

            if (title) {
                titleElement.textContent = title;
            } else {
                titleElement.textContent = "掲示板";
            }

            // --- 仮のサーバーから返ってくるデータ（実際にはAPIなどから取得予定） ---
            let posts = [];

            // 投稿を表示する親要素
            const postsContainer = document.getElementById("posts");

            // --- 投稿をHTMLに描画する関数 ---
            function renderPosts(responseToJson) {
                // いったん中身をクリア
                postsContainer.innerHTML = "";

                const postList = responseToJson.map((post) => ({
                    userName: post.userName,
                    post: post.post,
                    createdAt: post.createdAt,
                }));
                // 配列の内容を順に表示
                if (postList) {
                    posts = postList;
                }
                posts.forEach((p) => {
                    const div = document.createElement("div"); // 投稿全体のdivを作成
                    div.className = "post"; // CSS用クラスを付与
                    div.innerHTML = `
                    <div>    
                        <div class="user">${p.userName}</div>
                        <div class="content">${p.post}</div>
                    </div>
                    <div class="date">${p.createdAt}</div>
                `;
                    postsContainer.appendChild(div); // 親要素に追加
                });
            }

            // greetingを叩くためのjavascriptの実装
            window.onload = async () => {
                // いったん中身をクリア
                titleElement.innerHTML = "";

                try {
                    const span = document.createElement("span"); // タイトルのspanを作成
                    span.innerHTML = params.get("title");
                    titleElement.appendChild(span); // 親要素に追加

                    const endpoint = `/thread-posts?newspaper-id=${
                        params.get("newspaper-id")
                    }&index=${params.get("index")}`;
                    const response = await fetch(endpoint);
                    const responseToJson = await response.json();
                    renderPosts(responseToJson);
                } catch (e) {
                    console.log("error: ", e);
                }
            };

            // --- 送信ボタンが押されたときの処理 ---
            document.getElementById("submitBtn").addEventListener(
                "click",
                async () => {
                    // 入力値を取得
                    const getUserName = document.getElementById("userName").value
                        .trim();
                    const postContent = document.getElementById("postContent").value
                        .trim();

                    // 名前入力が空なら名前を"名無し"にする
                    const userName = (getUserName !== "") ? getUserName : "名無し";

                    // 入力が空ならアラートを表示して処理を中断
                    if (!postContent) {
                        alert("投稿内容を入力してください");
                        return;
                    }

                    // 新しい投稿を配列に追加
                    try {
                        const endpoint = `/new-posts?newspaper-id=${
                            params.get("newspaper-id")
                        }&index=${
                            params.get("index")
                        }&user-name=${userName}&post-content=${postContent}`;
                        const response = await fetch(endpoint);
                    } catch (e) {
                        console.log("error: ", e);
                    }
                    //posts.push({ userName, post: postContent, createdAt });

                    // 再描画して新しい投稿を反映
                    const endpoint = `/thread-posts?newspaper-id=${
                        params.get("newspaper-id")
                    }&index=${params.get("index")}`;
                    const response = await fetch(endpoint);
                    const responseToJson = await response.json();
                    renderPosts(responseToJson);

                    // 入力欄をリセット
                    document.getElementById("postContent").value = "";
                },
            );
        </script>
    </body>
</html>
